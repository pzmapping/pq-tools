--[[
    pq-tools - Decoration Multi Tool
    Author: Pabbiqo
    Repository: https://github.com/pzmapping/pq-tools
]]

DATA = {
    { label = '### Decoration - Multitiles ###' },

    {
        label = 'Picnic Table',
        dir = {
            { -- dir1
                w = 'camping_01_8',
                n = 'camping_01_9',
                e = 'camping_01_10',
                s = 'camping_01_11'
            },
            { -- dir2
                w = 'camping_01_12',
                n = 'camping_01_15',
                e = 'camping_01_13',
                s = 'camping_01_14'
            },
            { -- dir3
                w = 'camping_01_8',
                n = 'camping_01_9',
                e = 'camping_01_10',
                s = 'camping_01_11'
            },
            { -- dir4
                w = 'camping_01_12',
                n = 'camping_01_15',
                e = 'camping_01_13',
                s = 'camping_01_14'
            }
        }
    },

    {
        label = 'Playground Spinner',
        dir = {
            { -- dir1
                w = 'location_community_park_01_20',
                n = 'location_community_park_01_23',
                e = 'location_community_park_01_21',
                s = 'location_community_park_01_22'
            },
            { -- dir2
                w = 'location_community_park_01_20',
                n = 'location_community_park_01_23',
                e = 'location_community_park_01_21',
                s = 'location_community_park_01_22'
            },
            { -- dir3
                w = 'location_community_park_01_20',
                n = 'location_community_park_01_23',
                e = 'location_community_park_01_21',
                s = 'location_community_park_01_22'
            },
            { -- dir4
                w = 'location_community_park_01_20',
                n = 'location_community_park_01_23',
                e = 'location_community_park_01_21',
                s = 'location_community_park_01_22'
            }
        }
    },

    {
        label = 'Playground Slide',
        dir = {
            { -- dir1
                w = 'location_community_park_01_16',
                n = 'location_community_park_01_17',
                e = nil,
                s = nil
            },
            { -- dir2
                w = 'location_community_park_01_18',
                n = nil,
                e = 'location_community_park_01_19',
                s = nil
            },
            { -- dir3
                w = 'location_community_park_01_16',
                n = 'location_community_park_01_17',
                e = nil,
                s = nil
            },
            { -- dir4
                w = 'location_community_park_01_18',
                n = nil,
                e = 'location_community_park_01_19',
                s = nil
            }
        }
    },

    {
        label = 'Playground Castle',
        dir = {
            { -- dir1
                w = 'location_community_park_01_49',
                n = 'location_community_park_01_51',
                e = 'location_community_park_01_50',
                s = 'location_community_park_01_52'
            },
            { -- dir2
                w = 'location_community_park_01_49',
                n = 'location_community_park_01_51',
                e = 'location_community_park_01_50',
                s = 'location_community_park_01_52'
            },
            { -- dir3
                w = 'location_community_park_01_49',
                n = 'location_community_park_01_51',
                e = 'location_community_park_01_50',
                s = 'location_community_park_01_52'
            },
            { -- dir4
                w = 'location_community_park_01_49',
                n = 'location_community_park_01_51',
                e = 'location_community_park_01_50',
                s = 'location_community_park_01_52'
            }
        }
    },

    {
        label = 'Small wood East 1',
        dir = {
            { -- dir1
                w = 'camping_01_24',
                e = 'camping_01_25'
            }
        }
    },

    {
        label = 'Small wood East 2',
        dir = {
            { -- dir1
                w = 'camping_01_28',
                e = 'camping_01_29'
            }
        }
    },

    {
        label = 'Small wood South 1',
        dir = {
            { -- dir1
                w = 'camping_01_34',
                n = 'camping_01_35'
            }
        }
    },

    {
        label = 'Small wood South 2',
        dir = {
            { -- dir1
                w = 'camping_01_38',
                n = 'camping_01_39'
            }
        }
    },

    { label = '### Holes and Piles ###' },

    {
        label = 'Construction Sand Pile',
        dir = {
            { -- dir1
                w = 'construction_01_64',
                n = 'construction_01_67',
                e = 'construction_01_65',
                s = 'construction_01_66'
            },
            { -- dir2
                w = 'construction_01_68',
                n = 'construction_01_71',
                e = 'construction_01_70',
                s = 'construction_01_69'
            },
            { -- dir3
                w = 'construction_01_72',
                n = 'construction_01_75',
                e = 'construction_01_73',
                s = 'construction_01_74'
            }
        }
    },

    {
        label = 'Burned Coal Pile',
        dir = {
            { -- dir1
                w = 'crafted_01_124',
                e = 'crafted_01_125',
                s = 'crafted_01_126'
            }
        }
    },

    {
        label = 'Empty Hole',
        dir = {
            { -- dir1
                w = 'crafted_04_0',
                e = 'crafted_04_2',
                n = 'crafted_04_1',
                s = 'crafted_04_3'
            }
        }
    },

    {
        label = 'Hole with Burned Coal',
        dir = {
            { -- dir1
                w = 'crafted_04_4',
                e = 'crafted_04_6',
                n = 'crafted_04_5',
                s = 'crafted_04_7'
            }
        }
    },

    {
        label = 'Hole with new Coal 1',
        dir = {
            { -- dir1
                w = 'crafted_04_8',
                e = 'crafted_04_10',
                n = 'crafted_04_9',
                s = 'crafted_04_11'
            }
        }
    },

    {
        label = 'Hole with new Coal 2',
        dir = {
            { -- dir1
                w = 'crafted_04_16',
                e = 'crafted_04_18',
                n = 'crafted_04_17',
                s = 'crafted_04_19'
            }
        }
    },

    {
        label = 'Hole with Burning Coal 1',
        dir = {
            { -- dir1
                w = 'crafted_04_12',
                e = 'crafted_04_14',
                n = 'crafted_04_13',
                s = 'crafted_04_15'
            }
        }
    },

    {
        label = 'Hole with Burning Coal 2',
        dir = {
            { -- dir1
                w = 'crafted_04_20',
                e = 'crafted_04_22',
                n = 'crafted_04_21',
                s = 'crafted_04_23'
            }
        }
    },
}

LAYERS = {
    '0_Furniture',
    '0_Furniture1',
    '0_Furniture2',
    '0_Furniture3'
}

function options()
    local items = {}
    for i = 1, #DATA do
        items[i] = DATA[i].label
    end
    return {
        { name = 'type', label = 'Type:', type = 'list', items = items },
    }
end

function setOption(name, value)
    if name == 'type' and #DATA > 0 then
        CURDATA = DATA[value]
    end
end

function activate()
    self:setCursorType(TileTool.CurbTool)
    print 'activate'
end

function deactivate()
    print('deactivate')
end

function pickEmptyLayer(x, y)
    for _, layerName in ipairs(LAYERS) do
        local layer = map:tileLayer(layerName)
        if layer and not layer:tileAt(x, y) then
            return layerName
        end
    end
    return nil
end

local function previewTiles(dirIndex, x, y)
    local layerName = pickEmptyLayer(x, y)
    if not layerName then return false end

    local dir = CURDATA.dir[dirIndex]
    if not dir then return false end

    local offsets = { w = {0, 0}, n = {0, -1}, e = {1, 0}, s = {1, -1} }

    for k, pos in pairs(offsets) do
        if dir[k] then
            local tile = map:tile(dir[k])
            if tile then
                self:setToolTile(layerName, x + pos[1], y + pos[2], tile)
            end
        end
    end

    return true
end

local function placeTiles(dirIndex, x, y)
    local layerName = pickEmptyLayer(x, y)
    if not layerName then return false end

    local dir = CURDATA.dir[dirIndex]
    if not dir then return false end

    local offsets = { w = {0, 0}, n = {0, -1}, e = {1, 0}, s = {1, -1} }

    for k, pos in pairs(offsets) do
        if dir[k] then
            local tile = map:tile(dir[k])
            if tile then
                map:tileLayer(layerName):setTile(self.x + pos[1], self.y + pos[2], tile)
            end
        end
    end

    self:applyChanges('Draw ' .. CURDATA.label)
    return true
end

local function getDirIndex(modifiers)
    if modifiers.alt then return 4 end
    if modifiers.control then return 3 end
    if modifiers.shift then return 2 end
    return 1
end

function mouseMoved(buttons, x, y, modifiers)
    self:clearToolTiles()
    if x < 0 or y < 0 or x >= map:width() or y >= map:height() then
        self.ok = false
        return
    end
    self.ok = previewTiles(getDirIndex(modifiers), x, y)
end

function mousePressed(buttons, x, y, modifiers)
    if buttons.left then
        self.cancel = false
        self.x, self.y = x, y
    elseif buttons.right then
        self.cancel = true
    end
end

function mouseReleased(buttons, x, y, modifiers)
    if buttons.left and not self.cancel then
        self.ok = placeTiles(getDirIndex(modifiers), x, y)
    end
end

